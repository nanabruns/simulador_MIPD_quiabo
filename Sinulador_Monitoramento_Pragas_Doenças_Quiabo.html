
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Doenças e Pragas do Quiabo FATEC Rondonópolis-MT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Tailwind green-50 */
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #22c55e; /* Tailwind green-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #16a34a; /* Tailwind green-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* Tailwind gray-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
        }
        .info-tab {
            background-color: #e0f2fe; /* Tailwind sky-100 */
            border: 1px solid #7dd3fc; /* Tailwind sky-300 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .remedial-section {
            background-color: #fffbeb; /* Tailwind amber-50 */
            border: 1px solid #fde68a; /* Tailwind amber-200 */
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #86efac; /* Tailwind green-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e; /* Tailwind green-500 */
        }
        [type="checkbox"]:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #22c55e; /* Tailwind green-500 */
            border-color: #22c55e;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="container mx-auto p-4 max-w-3xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-green-700">Simulador de Doenças e Pragas do Quiabo</h1>
            <p class="text-lg text-green-600">FATEC Rondonópolis-MT</p>
        </header>

        <div id="welcomeScreen" class="text-center p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-green-700">Bem-vindo(a)!</h2>
            <p class="mb-2">Este simulador ajudará você a identificar e controlar as principais doenças e pragas da cultura do quiabo.</p>
            <p class="mb-4">Analise cada cenário, faça seu diagnóstico e escolha as melhores medidas de controle. Boa sorte!</p>
            <button id="startButton" class="btn btn-primary py-2 px-6 rounded-lg font-semibold text-lg">Iniciar Simulação</button>
        </div>

        <div id="scenarioScreen" class="hidden p-6 bg-white rounded-lg shadow-lg">
            <h2 id="scenarioTitle" class="text-2xl font-bold mb-6 text-center text-green-700"></h2>
            
            <div class="mb-4 p-3 bg-green-50 rounded-md border border-green-200">
                <h3 class="font-semibold text-lg text-green-600">Relatório de Campo:</h3>
                <p id="scenarioFieldReport" class="text-gray-700"></p>
            </div>

            <div class="mb-6 p-3 bg-green-50 rounded-md border border-green-200">
                <h3 class="font-semibold text-lg text-green-600">Notas Adicionais:</h3>
                <p id="scenarioFieldNotes" class="text-gray-700"></p>
            </div>

            <div class="mb-4">
                <label for="diagnosisSelect" class="block font-semibold mb-1 text-green-600">1. Qual o seu diagnóstico preliminar?</label>
                <select id="diagnosisSelect" class="w-full p-2 border border-green-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </select>
            </div>

            <div class="mb-6">
                <label class="block font-semibold mb-1 text-green-600">2. Quais medidas de controle você recomendaria? (Selecione até 3)</label>
                <div id="controlOptionsDiv" class="space-y-2">
                </div>
            </div>
            <p id="validationMessage" class="text-red-500 text-sm mb-2"></p>
            <button id="submitButton" class="w-full btn btn-primary py-2 px-4 rounded-lg font-semibold">Enviar Respostas</button>
        </div>

        <div id="feedbackScreen" class="hidden p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Feedback do Cenário</h2>
            <p id="feedbackDiagnosis" class="mb-2 text-lg"></p>
            <p id="feedbackControls" class="mb-2 text-lg"></p>

            <div class="mt-3 mb-3 p-3 bg-lime-50 border border-lime-200 rounded-md">
                <h4 class="font-semibold text-lime-700">Resumo de Pontos do Cenário:</h4>
                <p id="pointsDiagnosisDetail" class="text-sm text-lime-600"></p>
                <p id="pointsControlsDetail" class="text-sm text-lime-600"></p>
                <p id="pointsScenarioTotal" class="text-sm font-bold text-lime-700"></p>
            </div>

            <p id="scoreUpdate" class="font-semibold text-xl mb-2 text-center text-green-600"></p>
            <p id="lastRemedialResult" class="text-sm text-amber-600 mt-1 text-center mb-4 hidden"></p>


            <div id="infoTabDiv" class="info-tab hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-700">Informações Detalhadas sobre: <span id="infoProblemName" class="font-bold"></span></h3>
                <p class="mb-1"><strong class="text-sky-600">Agente Causal:</strong> <span id="infoCausalAgent"></span></p>
                <div class="mb-2">
                    <strong class="text-sky-600">Sintomas Principais:</strong>
                    <p id="infoSymptoms" class="ml-2 text-gray-700"></p>
                </div>
                <div class="mb-2">
                    <strong class="text-sky-600">Condições Favoráveis:</strong>
                    <p id="infoFavorableConditions" class="ml-2 text-gray-700"></p>
                </div>
                <div class="mb-2">
                    <strong class="text-sky-600">Impacto (se não controlado):</strong>
                    <p id="infoImpact" class="ml-2 text-gray-700"></p>
                </div>
                <div>
                    <strong class="text-sky-600">Estratégias de Manejo Integrado:</strong>
                    <ul class="list-disc ml-6 text-gray-700 space-y-1">
                        <li id="infoPreventiveCultural"><strong>Preventivo/Cultural:</strong> <span></span></li>
                        <li id="infoBiological" class="hidden"><strong>Biológico:</strong> <span></span></li>
                        <li id="infoChemical" class="hidden"><strong>Químico:</strong> <span></span></li>
                    </ul>
                </div>
                <div id="infoNaturalEnemiesDiv" class="mt-2 hidden">
                    <strong class="text-sky-600">Inimigos Naturais Relevantes:</strong>
                    <p id="infoNaturalEnemies" class="ml-2 text-gray-700"></p>
                </div>
            </div>

            <div id="remedialSectionDiv" class="remedial-section info-tab hidden mt-6 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-amber-700">Sessão de Recuperação</h3>
                <p class="mb-3 text-amber-600">Parece que algumas respostas não foram assertivas. Responda às perguntas abaixo para tentar recuperar alguns pontos:</p>
                <div id="remedialQuestionsContainer">
                </div>
                <button id="submitRemedialButton" class="mt-4 btn bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-lg font-semibold">Enviar Respostas da Recuperação</button>
            </div>
            
            <button id="nextScenarioButton" class="w-full btn btn-primary mt-6 py-2 px-4 rounded-lg font-semibold">Próximo Cenário</button>
            <button id="restartButton" class="w-full btn btn-secondary mt-2 py-2 px-4 rounded-lg font-semibold hidden">Reiniciar Simulação</button>
        </div>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Baseado em informações técnicas da Embrapa.</p>
            <p>Simulador desenvolvido para fins educacionais.</p>
            <p id="userIdDisplay" class="mt-2"></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'okra-simulator-default';
        
        let app, auth, db, userId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            if (!app) app = {};
            if (!auth) auth = { currentUser: { uid: crypto.randomUUID() } }; 
            if (!db) db = {}; 
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
                document.getElementById('userIdDisplay').textContent = `ID do Usuário: ${userId}`;
            } else {
                console.log("User is signed out. Attempting to sign in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    userId = `anon-${crypto.randomUUID()}`; 
                     document.getElementById('userIdDisplay').textContent = `ID do Usuário (Fallback): ${userId}`;
                }
            }
        });

        const scenarios = [
            {
                id: "oidio_01",
                title: "O Ataque Pulverulento",
                fieldReport_pt: "Você está inspecionando uma lavoura de quiabo com 60 dias. O tempo tem estado seco e quente. As folhas mais velhas de várias plantas apresentam uma cobertura esbranquiçada, parecida com pó de giz.",
                fieldNotes_pt: "Partes afetadas: Principalmente folhas mais velhas, mas pode ocorrer em hastes e frutos. Condições: Períodos secos, plantios adensados e sombreados. Inimigos naturais: Não são diretamente aplicáveis para esta doença fúngica, mas um ambiente equilibrado é sempre bom.",
                problemFocus_pt: "Oídio",
                causalAgent_pt: "Oidium sp. (fungo)",
                diagnosisOptions_pt: ["Oídio", "Míldio", "Cercosporiose", "Mancha Angular"],
                correctDiagnosis_pt: "Oídio",
                controlOptions_pt: [
                    { text_pt: "Aumentar a ventilação da área e evitar plantios muito adensados.", isCorrect: true, feedback_pt: "Correto. Melhora a aeração e reduz condições favoráveis ao fungo." },
                    { text_pt: "Realizar irrigações por aspersão para lavar os esporos.", isCorrect: true, feedback_pt: "Correto. A água pode remover os esporos, desfavorecendo a doença." },
                    { text_pt: "Aplicar fungicida à base de enxofre ou outro registrado no MAPA, se a infestação for severa no início da produção.", isCorrect: true, feedback_pt: "Correto. O controle químico pode ser necessário em casos de alta pressão da doença. Sempre verificar produtos registrados no Agrofit." },
                    { text_pt: "Aumentar a adubação nitrogenada.", isCorrect: false, feedback_pt: "Incorreto. Excesso de nitrogênio pode levar a um crescimento vegetativo exuberante e tenro, potencialmente favorecendo algumas doenças." }
                ],
                infoTab_pt: {
                    symptoms_pt: "Manchas brancas pulverulentas (como pó de giz) nas folhas, que podem se espalhar. Sob ataque severo, as folhas amarelecem e caem. Frutos também podem apresentar o pó branco.",
                    favorableConditions_pt: "Períodos mais secos (chuva e irrigação por aspersão lavam os esporos). Plantios sombreados e muito densos.",
                    impact_pt: "Redução da área fotossintética, queda prematura de folhas, diminuição da produtividade e qualidade dos frutos.",
                    managementStrategies_pt: {
                        preventiveCultural_pt: ["Escolher local de plantio bem ventilado.", "Evitar plantios muito adensados.", "A irrigação por aspersão pode ajudar a controlar, pois lava os esporos.", "Eliminar restos de cultura."],
                        biological_pt: [],
                        chemical_pt: ["Em caso de alta intensidade no início da produção, pode ser necessária a aplicação de fungicidas registrados no MAPA (consultar Agrofit)."]
                    },
                    naturalEnemies_pt: ""
                },
                remedialQuestions_pt: [
                    { question_pt: "Qual o aspecto característico das lesões de Oídio nas folhas?", options_pt: ["Manchas escuras e oleosas", "Pó branco semelhante a giz", "Pequenos furos com bordas amarelas"], correctAnswer_pt: "Pó branco semelhante a giz" },
                    { question_pt: "A irrigação por aspersão favorece ou desfavorece o Oídio? Por quê?", options_pt: ["Favorece, pois aumenta a umidade.", "Desfavorece, pois lava os esporos das folhas.", "Não tem efeito."], correctAnswer_pt: "Desfavorece, pois lava os esporos das folhas." }
                ]
            },
            {
                id: "pulgoes_01",
                title: "Visitantes Indesejados (e alguns amigos)",
                fieldReport_pt: "Em uma inspeção em plantas jovens de quiabo, você nota que os brotos e a face inferior das folhas novas estão cobertos por pequenos insetos esverdeados. Há uma substância pegajosa e brilhante nas folhas abaixo da infestação.",
                fieldNotes_pt: "Partes afetadas: Brotos novos, face inferior das folhas. Condições: Temperatura entre 24-27°C é favorável. Inimigos naturais: Presença de joaninhas e larvas de crisopídeos (bicho-lixeiro) observadas alimentando-se dos pulgões.",
                problemFocus_pt: "Pulgão-do-algodoeiro",
                causalAgent_pt: "Aphis gossypii (inseto sugador)",
                diagnosisOptions_pt: ["Ácaro-rajado", "Pulgão-do-algodoeiro", "Tripes", "Mosca-branca"],
                correctDiagnosis_pt: "Pulgão-do-algodoeiro",
                controlOptions_pt: [
                    { text_pt: "Aplicar inseticida de amplo espectro imediatamente.", isCorrect: false, feedback_pt: "Incorreto. Isso pode eliminar os inimigos naturais presentes, que estão ajudando no controle." },
                    { text_pt: "Monitorar a população de pulgões e inimigos naturais. Intervir quimicamente apenas se os danos aumentarem significativamente e os inimigos naturais não forem suficientes, usando produtos seletivos (se disponíveis e registrados).", isCorrect: true, feedback_pt: "Correto. Priorizar o controle biológico natural e usar químicos como último recurso." },
                    { text_pt: "Eliminar plantas daninhas hospedeiras ao redor da cultura.", isCorrect: true, feedback_pt: "Correto. Reduz fontes alternativas de infestação para os pulgões." },
                    { text_pt: "Realizar pulverizações com óleo de nim, se necessário e como alternativa menos impactante aos inimigos naturais.", isCorrect: true, feedback_pt: "Correto. Óleos vegetais podem ser uma opção de controle com menor impacto ambiental, mas sempre verificar a recomendação para a cultura e o registro." }
                ],
                infoTab_pt: {
                    symptoms_pt: "Sucção de seiva, levando ao enfraquecimento da planta. Presença de 'fumagina' (mofo preto) sobre o 'honeydew' (líquido açucarado excretado pelos pulgões). Deformação de brotos e folhas. Podem transmitir viroses.",
                    favorableConditions_pt: "Temperaturas em torno de 24-27°C. Ausência de inimigos naturais pode levar a surtos populacionais.",
                    impact_pt: "Redução do vigor das plantas, perdas de produtividade, transmissão de doenças.",
                    managementStrategies_pt: {
                        preventiveCultural_pt: ["Uso de sementes sadias.", "Adequação da época de plantio.", "Isolamento de áreas de plantio.", "Eliminação de plantas hospedeiras (daninhas e silvestres).", "Rotação de culturas com plantas não hospedeiras.", "Implantação de barreiras vivas."],
                        biological_pt: ["Preservação e incremento de inimigos naturais como joaninhas (Coccinellidae), crisopídeos (Chrysopidae), sirfídeos (Syrphidae) e parasitoides."],
                        chemical_pt: ["O PDF 'Manejo de pragas' menciona que não há agrotóxicos registrados no MAPA para o controle de insetos sugadores na cultura do quiabeiro, enfatizando outras táticas. Caso haja atualização, consultar Agrofit e priorizar produtos seletivos."]
                    },
                    naturalEnemies_pt: "Joaninhas, larvas de crisopídeos (bicho-lixeiro), sirfídeos, pequenas vespas parasitoides."
                },
                remedialQuestions_pt: [
                    { question_pt: "Qual o principal dano direto causado pelos pulgões?", options_pt: ["Comer as folhas", "Sugar a seiva das plantas", "Fazer galerias nos frutos"], correctAnswer_pt: "Sugar a seiva das plantas" },
                    { question_pt: "Por que é importante considerar a presença de joaninhas antes de aplicar um inseticida contra pulgões?", options_pt: ["Joaninhas também comem as plantas", "Joaninhas são inimigos naturais dos pulgões e ajudam no controle", "Joaninhas não têm relação com pulgões"], correctAnswer_pt: "Joaninhas são inimigos naturais dos pulgões e ajudam no controle" }
                ]
            },
            {
                id: "nematoide_galhas_01",
                title: "Raízes Problemáticas",
                fieldReport_pt: "As plantas de quiabo em uma determinada área do campo estão apresentando subdesenvolvimento, amarelecimento e murcha nas horas mais quentes do dia, mesmo com irrigação aparentemente adequada. O cultivo anterior na área foi de tomate.",
                fieldNotes_pt: "Partes afetadas: Raízes. Ao arrancar uma planta, observam-se numerosas galhas (inchaços) nas raízes. Condições: Solos infestados, rotação inadequada com culturas suscetíveis. Inimigos naturais: Alguns fungos e bactérias no solo podem ser antagonistas, mas o manejo cultural é chave.",
                problemFocus_pt: "Nematoide-das-galhas",
                causalAgent_pt: "Meloidogyne incognita, Meloidogyne javanica (nematoides)",
                diagnosisOptions_pt: ["Murcha de Fusário", "Podridão radicular", "Nematoide-das-galhas", "Deficiência nutricional severa"],
                correctDiagnosis_pt: "Nematoide-das-galhas",
                controlOptions_pt: [
                    { text_pt: "Realizar rotação de culturas com gramíneas (ex: milho, sorgo) por pelo menos 3 anos.", isCorrect: true, feedback_pt: "Correto. Gramíneas são não hospedeiras ou más hospedeiras para muitas espécies de Meloidogyne, ajudando a reduzir a população no solo." },
                    { text_pt: "Plantar crotalária (Crotalaria spectabilis) ou cravo-de-defunto (Tagetes sp.) na área infestada e incorporá-los ao solo.", isCorrect: true, feedback_pt: "Correto. Essas plantas têm efeito nematicida ou supressor sobre os nematoides-das-galhas." },
                    { text_pt: "Aplicar nematicida químico granulado no sulco de plantio.", isCorrect: false, feedback_pt: "Parcialmente correto, mas com ressalvas. O COT-126 menciona que o controle químico não tem sido efetivo e deve ser evitado por questões ambientais e de custo. Priorizar medidas culturais e biológicas." },
                    { text_pt: "Aumentar a frequência de irrigação para compensar a má absorção de água.", isCorrect: false, feedback_pt: "Incorreto. Embora a planta sofra com a absorção de água, o excesso de umidade não resolve o problema dos nematoides e pode trazer outros problemas radiculares." }
                ],
                infoTab_pt: {
                    symptoms_pt: "Formação de galhas (inchaços) nas raízes, que comprometem a absorção de água e nutrientes. Na parte aérea: subdesenvolvimento (nanismo), amarelecimento, murcha nas horas mais quentes, redução da produção.",
                    favorableConditions_pt: "Solos infestados. Cultivo sucessivo de plantas suscetíveis. Temperaturas do solo favoráveis ao desenvolvimento dos nematoides.",
                    impact_pt: "Perdas significativas na produção, podendo inviabilizar o cultivo na área se não manejado.",
                    managementStrategies_pt: {
                        preventiveCultural_pt: ["Plantio em áreas não infestadas (difícil saber sem análise).", "Rotação de culturas com espécies não suscetíveis (gramíneas) por 3 anos ou mais.", "Plantio de culturas antagonistas como Crotalaria sp. ou Tagetes sp. (cravo-de-defunto).", "Uso de matéria orgânica no solo (favorece microrganismos antagonistas).", "Evitar trânsito de máquinas e implementos de áreas infestadas para áreas sadias."],
                        biological_pt: ["Uso de matéria orgânica estimula inimigos naturais no solo. Alguns produtos biológicos à base de fungos ou bactérias nematófagas podem estar disponíveis."],
                        chemical_pt: ["O controle químico de nematoides não tem sido efetivo e deve ser evitado por questões ambientais e de custo (COT-126). Não existem variedades de quiabo resistentes mencionadas nos PDFs."]
                    },
                    naturalEnemies_pt: "Fungos nematófagos (ex: Paecilomyces, Trichoderma), bactérias (ex: Pasteuria penetrans) e outros microrganismos do solo que são antagônicos aos nematoides."
                },
                remedialQuestions_pt: [
                    { question_pt: "Qual o principal sintoma visível nas raízes de plantas de quiabo atacadas por nematoide-das-galhas?", options_pt: ["Raízes escurecidas e podres", "Presença de galhas ou inchaços", "Ausência de raízes secundárias"], correctAnswer_pt: "Presença de galhas ou inchaços" },
                    { question_pt: "Cite uma prática cultural importante para o manejo de nematoide-das-galhas.", options_pt: ["Adubação nitrogenada pesada", "Rotação de culturas com gramíneas", "Plantio adensado"], correctAnswer_pt: "Rotação de culturas com gramíneas" }
                ]
            }
        ];

        let currentScenarioIndex = 0;
        let score = 0;
        // const maxScorePerScenario = 100; // Not strictly used for display, but for internal logic if needed

        const welcomeScreen = document.getElementById('welcomeScreen');
        const scenarioScreen = document.getElementById('scenarioScreen');
        const feedbackScreen = document.getElementById('feedbackScreen');
        
        const startButton = document.getElementById('startButton');
        const submitButton = document.getElementById('submitButton');
        const nextScenarioButton = document.getElementById('nextScenarioButton');
        const restartButton = document.getElementById('restartButton');
        const submitRemedialButton = document.getElementById('submitRemedialButton');

        const scenarioTitle = document.getElementById('scenarioTitle');
        const scenarioFieldReport = document.getElementById('scenarioFieldReport');
        const scenarioFieldNotes = document.getElementById('scenarioFieldNotes');
        const diagnosisSelect = document.getElementById('diagnosisSelect');
        const controlOptionsDiv = document.getElementById('controlOptionsDiv');
        const validationMessage = document.getElementById('validationMessage');

        const feedbackDiagnosis = document.getElementById('feedbackDiagnosis');
        const feedbackControls = document.getElementById('feedbackControls');
        const scoreUpdate = document.getElementById('scoreUpdate');
        const infoTabDiv = document.getElementById('infoTabDiv');
        const remedialSectionDiv = document.getElementById('remedialSectionDiv');
        const remedialQuestionsContainer = document.getElementById('remedialQuestionsContainer');
        const lastRemedialResult = document.getElementById('lastRemedialResult');

        // Elements for detailed scenario score
        const pointsDiagnosisDetail = document.getElementById('pointsDiagnosisDetail');
        const pointsControlsDetail = document.getElementById('pointsControlsDetail');
        const pointsScenarioTotal = document.getElementById('pointsScenarioTotal');


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadScenario(index) {
            // shuffleArray(scenarios); // Shuffle scenarios each time simulation starts - Decided against for consistent testing during dev
            const scenario = scenarios[index];
            if (!scenario) {
                endSimulation();
                return;
            }

            scenarioTitle.textContent = scenario.title;
            scenarioFieldReport.textContent = scenario.fieldReport_pt;
            scenarioFieldNotes.textContent = scenario.fieldNotes_pt;
            validationMessage.textContent = "";
            lastRemedialResult.classList.add('hidden'); // Hide previous remedial result

            diagnosisSelect.innerHTML = '<option value="">Selecione o diagnóstico...</option>';
            let diagnosisOptions = [...scenario.diagnosisOptions_pt]; 
            shuffleArray(diagnosisOptions); 
            diagnosisOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                diagnosisSelect.appendChild(option);
            });

            controlOptionsDiv.innerHTML = '';
            let controlOptions = [...scenario.controlOptions_pt]; 
            shuffleArray(controlOptions); 
            controlOptions.forEach((opt, i) => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `control_${i}`;
                checkbox.value = opt.text_pt;
                checkbox.classList.add('mr-2', 'h-4', 'w-4', 'text-green-600', 'border-gray-300', 'rounded', 'focus:ring-green-500');
                const label = document.createElement('label');
                label.htmlFor = `control_${i}`;
                label.textContent = opt.text_pt;
                label.classList.add('text-gray-700');
                div.appendChild(checkbox);
                div.appendChild(label);
                controlOptionsDiv.appendChild(div);
            });

            welcomeScreen.classList.add('hidden');
            feedbackScreen.classList.add('hidden');
            scenarioScreen.classList.remove('hidden');
            infoTabDiv.classList.add('hidden');
            remedialSectionDiv.classList.add('hidden');
        }

        function showFeedback() {
            const scenario = scenarios[currentScenarioIndex];
            let diagnosisCorrect = false;
            let controlFeedbackText = "Feedback das medidas de controle:<br>";
            let correctControlsChosen = 0;
            let incorrectControlsChosen = 0;
            const totalCorrectControls = scenario.controlOptions_pt.filter(opt => opt.isCorrect).length;
            
            let diagnosisScore = 0;
            const maxDiagnosisScore = 40;

            if (diagnosisSelect.value === scenario.correctDiagnosis_pt) {
                feedbackDiagnosis.innerHTML = `<strong class="text-green-600">Diagnóstico: Correto!</strong> (${scenario.correctDiagnosis_pt})`;
                diagnosisScore = maxDiagnosisScore;
                diagnosisCorrect = true;
            } else {
                feedbackDiagnosis.innerHTML = `<strong class="text-red-600">Diagnóstico: Incorreto.</strong> Você selecionou '${diagnosisSelect.value || "Nenhum"}'. O correto era '${scenario.correctDiagnosis_pt}'.`;
            }

            const selectedControls = [];
            controlOptionsDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedControls.push(cb.value);
            });

            scenario.controlOptions_pt.forEach(opt => {
                const chosen = selectedControls.includes(opt.text_pt);
                if (chosen) {
                    if (opt.isCorrect) {
                        controlFeedbackText += `<span class="text-green-500">✔ ${opt.text_pt} (${opt.feedback_pt})</span><br>`;
                        correctControlsChosen++;
                    } else {
                        controlFeedbackText += `<span class="text-red-500">✖ ${opt.text_pt} (${opt.feedback_pt})</span><br>`;
                        incorrectControlsChosen++;
                    }
                }
            });
            
            let controlScore = 0;
            const maxControlScore = 60;

            if (totalCorrectControls > 0) {
                const pointsPerCorrect = maxControlScore / totalCorrectControls;
                controlScore += correctControlsChosen * pointsPerCorrect;
                // Penalidade mais branda: subtrai uma fração dos pontos por escolha incorreta
                controlScore -= incorrectControlsChosen * (pointsPerCorrect / 2); 
            } else { 
                if (selectedControls.length === 0) {
                    controlScore = maxControlScore; 
                } else {
                    controlScore = 0; // Penalidade total se escolheu algo quando não deveria
                }
            }
            controlScore = Math.max(0, Math.round(controlScore));

            const currentScenarioEarnedPoints = Math.round(diagnosisScore + controlScore);
            score += currentScenarioEarnedPoints;

            feedbackControls.innerHTML = controlFeedbackText;
            
            pointsDiagnosisDetail.textContent = `Pontos do Diagnóstico: ${Math.round(diagnosisScore)} / ${maxDiagnosisScore}`;
            pointsControlsDetail.textContent = `Pontos das Medidas de Controle: ${controlScore} / ${maxControlScore}`;
            pointsScenarioTotal.textContent = `Total de Pontos Ganhos neste Cenário: ${currentScenarioEarnedPoints}`;
            scoreUpdate.textContent = `Pontuação Total Acumulada: ${score}`;

            document.getElementById('infoProblemName').textContent = scenario.problemFocus_pt;
            document.getElementById('infoCausalAgent').textContent = scenario.causalAgent_pt;
            document.getElementById('infoSymptoms').innerHTML = scenario.infoTab_pt.symptoms_pt.replace(/\n/g, '<br>');
            document.getElementById('infoFavorableConditions').innerHTML = scenario.infoTab_pt.favorableConditions_pt.replace(/\n/g, '<br>');
            document.getElementById('infoImpact').innerHTML = scenario.infoTab_pt.impact_pt.replace(/\n/g, '<br>');
            
            const preventiveCulturalLi = document.getElementById('infoPreventiveCultural');
            if (scenario.infoTab_pt.managementStrategies_pt.preventiveCultural_pt.length > 0) {
                 preventiveCulturalLi.querySelector('span').innerHTML = "- " + scenario.infoTab_pt.managementStrategies_pt.preventiveCultural_pt.join('<br>- ');
            } else {
                preventiveCulturalLi.querySelector('span').textContent = "Nenhuma específica detalhada.";
            }

            const biologicalLi = document.getElementById('infoBiological');
            if (scenario.infoTab_pt.managementStrategies_pt.biological_pt && scenario.infoTab_pt.managementStrategies_pt.biological_pt.length > 0) {
                biologicalLi.querySelector('span').innerHTML = "- " + scenario.infoTab_pt.managementStrategies_pt.biological_pt.join('<br>- ');
                biologicalLi.classList.remove('hidden');
            } else {
                biologicalLi.classList.add('hidden');
            }

            const chemicalLi = document.getElementById('infoChemical');
            if (scenario.infoTab_pt.managementStrategies_pt.chemical_pt && scenario.infoTab_pt.managementStrategies_pt.chemical_pt.length > 0) {
                chemicalLi.querySelector('span').innerHTML = "- " + scenario.infoTab_pt.managementStrategies_pt.chemical_pt.join('<br>- ');
                chemicalLi.classList.remove('hidden');
            } else {
                chemicalLi.classList.add('hidden');
            }
            
            const naturalEnemiesDiv = document.getElementById('infoNaturalEnemiesDiv');
            const naturalEnemiesP = document.getElementById('infoNaturalEnemies');
            if (scenario.infoTab_pt.naturalEnemies_pt && scenario.infoTab_pt.naturalEnemies_pt.trim() !== "") {
                naturalEnemiesP.textContent = scenario.infoTab_pt.naturalEnemies_pt;
                naturalEnemiesDiv.classList.remove('hidden');
            } else {
                naturalEnemiesDiv.classList.add('hidden');
            }

            infoTabDiv.classList.remove('hidden');

            if (!diagnosisCorrect || (totalCorrectControls > 0 && correctControlsChosen < totalCorrectControls) || incorrectControlsChosen > 0) {
                loadRemedialQuestions(scenario);
                remedialSectionDiv.classList.remove('hidden');
            } else {
                remedialSectionDiv.classList.add('hidden');
            }

            scenarioScreen.classList.add('hidden');
            feedbackScreen.classList.remove('hidden');
        }

        function loadRemedialQuestions(scenario) {
            remedialQuestionsContainer.innerHTML = '';
            scenario.remedialQuestions_pt.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.classList.add('mb-4');
                const qLabel = document.createElement('p');
                qLabel.classList.add('font-medium', 'mb-1', 'text-amber-700');
                qLabel.textContent = `${index + 1}. ${q.question_pt}`;
                qDiv.appendChild(qLabel);

                q.options_pt.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.classList.add('flex', 'items-center', 'ml-2');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `remedial_${index}`;
                    radio.value = opt;
                    radio.id = `remedial_${index}_${opt.replace(/\s+/g, '')}`;
                    radio.classList.add('mr-1.5', 'h-4', 'w-4', 'text-amber-600', 'border-gray-300', 'focus:ring-amber-500');
                    
                    const label = document.createElement('label');
                    label.htmlFor = radio.id;
                    label.textContent = opt;
                    label.classList.add('text-sm', 'text-gray-700');
                    
                    optDiv.appendChild(radio);
                    optDiv.appendChild(label);
                    qDiv.appendChild(optDiv);
                });
                remedialQuestionsContainer.appendChild(qDiv);
            });
        }

        function handleSubmitRemedial() {
            const scenario = scenarios[currentScenarioIndex];
            let remedialPoints = 0;
            const pointsPerRemedial = 10; 

            scenario.remedialQuestions_pt.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="remedial_${index}"]:checked`);
                if (selectedOption && selectedOption.value === q.correctAnswer_pt) {
                    remedialPoints += pointsPerRemedial;
                }
            });
            
            if (remedialPoints > 0) {
                score += remedialPoints;
                scoreUpdate.textContent = `Pontuação Total Acumulada: ${score}`;
                lastRemedialResult.textContent = `Feedback da Recuperação: Você ganhou +${remedialPoints} pontos!`;
                alert(`Você recuperou ${remedialPoints} pontos!`);
            } else {
                lastRemedialResult.textContent = `Feedback da Recuperação: Nenhum ponto adicional ganho desta vez.`;
                alert("Nenhum ponto adicional recuperado desta vez.");
            }
            lastRemedialResult.classList.remove('hidden');
            remedialSectionDiv.classList.add('hidden'); 
        }


        function endSimulation() {
            scenarioScreen.classList.add('hidden');
            feedbackScreen.classList.remove('hidden');
            infoTabDiv.classList.add('hidden');
            remedialSectionDiv.classList.add('hidden');

            const totalPossibleScore = scenarios.length * (40 + 60); // Max diagnosis + Max control per scenario

            feedbackDiagnosis.textContent = "Simulação Concluída!";
            feedbackControls.innerHTML = `Sua pontuação final é: <strong class="text-green-700">${score}</strong> de ${totalPossibleScore} pontos possíveis.`;
            scoreUpdate.textContent = `Pontuação Final: ${score}`;
            lastRemedialResult.classList.add('hidden');
            nextScenarioButton.classList.add('hidden');
            restartButton.classList.remove('hidden');
        }
        
        startButton.addEventListener('click', () => {
            // Shuffle scenarios array once at the beginning of the simulation
            shuffleArray(scenarios); 
            currentScenarioIndex = 0;
            score = 0;
            scoreUpdate.textContent = `Pontuação Total Acumulada: ${score}`;
            restartButton.classList.add('hidden');
            nextScenarioButton.classList.remove('hidden');
            lastRemedialResult.classList.add('hidden');
            loadScenario(currentScenarioIndex);
        });

        submitButton.addEventListener('click', () => {
            const selectedControlsCount = controlOptionsDiv.querySelectorAll('input[type="checkbox"]:checked').length;
            if (diagnosisSelect.value === "") {
                validationMessage.textContent = "Por favor, selecione um diagnóstico.";
                return;
            }
            // Removed the check for at least one control if options are available, to allow user to submit if they believe no control is needed.
            // if (selectedControlsCount === 0 && scenarios[currentScenarioIndex].controlOptions_pt.length > 0) {
            //      validationMessage.textContent = "Por favor, selecione pelo menos uma medida de controle ou confirme se nenhuma é aplicável.";
            //      return;
            // }
             if (selectedControlsCount > 3) {
                validationMessage.textContent = "Por favor, selecione no máximo 3 medidas de controle.";
                return;
            }
            validationMessage.textContent = "";
            showFeedback();
        });

        nextScenarioButton.addEventListener('click', () => {
            currentScenarioIndex++;
            if (currentScenarioIndex < scenarios.length) {
                loadScenario(currentScenarioIndex);
            } else {
                endSimulation();
            }
        });

        restartButton.addEventListener('click', () => {
            welcomeScreen.classList.remove('hidden');
            feedbackScreen.classList.add('hidden');
            scenarioScreen.classList.add('hidden');
        });
        
        submitRemedialButton.addEventListener('click', handleSubmitRemedial);
    </script>
</body>
</html>
